---
title: "Untitled"
output: html_document
date: "2022-09-10"
params:
  markers: "../../markers/scRNASeq.yml"
  sce: "../../data/scRNASeq/scRNASeq-train.rds"
  needed_cells: "20"
  rem_cell_type: "Megakaryocyte"
  initial: "ranking"
  AL_alg: "multinom"
  strat: "highest_entropy"
  criterion: "entropy"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages({
  library(tidyverse)
  library(yaml)
  library(data.table)
  library(caret)
  library(SingleCellExperiment)
  library(fabricatr)
})
source("../../pipeline/whatsthatcell-helpers.R")
```

### Read in data
```{r}
cell_type_to_rem <- params$rem_cell_type
markers <- read_yaml(params$markers)

if(grepl('entropy', params$strat)){
  criterion <- 'entropy'
}else{
  criterion <- 'maxp'
}

# Create marker file with only markers for missing cell type
missing_cell_type_markers <- markers
marker_index_rem <- which(names(markers$cell_types) == cell_type_to_rem)
missing_cell_type_markers$cell_types <- markers$cell_types[marker_index_rem]

sces <- str_split(params$sce, " ")[[1]]
```


```{r warning = FALSE}
uncertainties <- lapply(sces[1:2], function(x){
  # compare_entropies_rem_cell_type_wrapper <- function()
  # Calculate PCA embedding & filter genes
  features <- create_features(x)
  
  ### REMOVED CELL TYPE #####
  # Create initial training set with removed cell type
  selected_cells_rem_cell_type <- get_training_type_rem(features$expression, 
                                                        params$initial, 
                                                        markers)
  
  missing_cell_type_PCA <- left_join(features$PCA, selected_cells_rem_cell_type) # Adds the cell type labels
  
  # Run active learning with removed cell type
  missing_cell_type_uncertainty <- rem_cell_type_AL_wrapper(missing_cell_type_PCA,
                                                            params$AL_alg,
                                                            params$strat,
                                                            rand = 0,
                                                            criterion = criterion) |> # Need to add params here
    bind_rows() |> 
    as_tibble() |> 
    mutate(comp = "missing cell types",
           num_missing_cells = 0) |> 
    left_join(select(features$expression, X1, gt_cell_type), by = c("cell_id" = "X1"))
  
  ### KEPT CELL TYPE #####
  # Find all the cells of the type removed above that would otherwise have been selected 
  # These will then be included in the training data
  selected_cells_kept_df <- get_training_type_kept(features$expression, cell_type_to_rem, 
                                                   params$initial, 
                                                   missing_cell_type_markers, 
                                                   selected_cells_rem_cell_type)
  
  # Run active learning with kept cell type
  # Runs three times with 1, 2 and 3 cells of the removed type
  kept_cells_uncertainty <- lapply(selected_cells_kept_df, function(x){
    df_PCA <- left_join(features$PCA, 
                        select(x, -num_missing_cells), 
                        by = "X1")
    
    entr <- rem_cell_type_AL_wrapper(df_PCA,
                                     params$AL_alg,
                                     params$strat,
                                     rand = 0,
                                     criterion = criterion) # ADD params here
    
    bind_rows(entr) |> 
      as_tibble() |> 
      mutate(comp = "kept cell types",
             num_missing_cells = unique(x$num_missing_cells))
  }) |> bind_rows() |> 
    left_join(select(features$expression, X1, gt_cell_type), by = c("cell_id" = "X1"))
  
  bind_rows(missing_cell_type_uncertainty,
          kept_cells_uncertainty) |> 
    mutate(dataset = x)
}) |> bind_rows()
```


## Plot

Plot shows entropy or maxp (uncertainty) on the y axis for all cells in the training dataset
Facet = ground truth cell type 
Title = cell type that was not included in ranking
x = Number of cells annotated at this point (10 = 10 ranked cells, 20 = 10 ranked + 10 labeled w/ AL, etc.)
fill = How many cells of the removed type (see title) are in the initial 10 cells (if 0, this is the initial dataset with all cells of this type removed. If 1, one cell of this type in initial 10 cells, if 2, two cells of this type in initial 10 cells etc.)

I am expecting the Entropy to be higher for the removed cell type in the initial dataset that contains no cells of this type than the dataset that contains 1, 2, or 3 cells of this type. However, the opposite is the case.

```{r}
uncertainties |> 
  ggplot(aes(x = as.character(no_cells_annotated), y = criterion_val, fill = as.character(num_missing_cells))) + 
  geom_boxplot() + 
  labs(y = "Entropy", fill = "Number of cells of\nthe type removed\nin ranked dataset",
       title = paste("Cell type removed", cell_type_to_rem), 
       x = "Number of cells in traning set\n(starts out with 10 cells, then 10 additional cells with each AL iteration)") +
  facet_wrap(~gt_cell_type) + 
  whatsthatcell_theme()
```


