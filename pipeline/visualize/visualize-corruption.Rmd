---
title: "Visualize corruption"
output: html_document
params:
  AL_files_path: "../../data/CyTOF/Active-Learning/AL-batches-subset"
  sce: "../../data/CyTOF/CyTOF-train.rds"
  modality: ""
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../../')
suppressPackageStartupMessages({
  library(readr)
  library(magrittr)
  library(ggalluvial)
  library(tidyr)
  library(dplyr)
})
source("../../pipeline/whatsthatcell-helpers.R")
```



```{r message = FALSE}
AL_files <- list.files(params$AL_files_path, full.names = TRUE, pattern = "tsv")
AL <- lapply(AL_files, read_tsv) %>% 
  bind_rows() %>% 
  mutate(method = gsub("Active-Learning-groundTruth-strategy-", "", method)) %>% 
  separate(method, into = c('strategy', 'r', 'random', 'c', 'corrupted'), sep = '-') %>% 
  select(-c(r, c))
head(AL)
```


```{r fig.width=13, fig.height=20}
AL_alluvial <- function(AL, cells){
  AL %>% 
    pivot_longer(c(cell_type, corrupted_cell_type), names_to = "gt_or_mutated", values_to = "cell_type") %>% 
    filter(cell_num == cells) %>% 
    ggplot(aes(x = gt_or_mutated, stratum = cell_type, fill = cell_type, alluvium = cell_id)) +
    geom_stratum() +
    geom_flow() +
    scale_fill_manual(values = cell_type_colours()) +
    whatsthatcell_theme() +
    facet_grid(random + strategy ~ corrupted, scales = "free_y") +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
}

lapply(unique(AL$cell_num), function(x){
  AL_alluvial(AL, x)
})

```

